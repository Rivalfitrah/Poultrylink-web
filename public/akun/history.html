<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../src/output.css" rel="stylesheet" />
    <link rel="stylesheet" href="../src/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/@heroicons/react/outline"></script>
    <title>PoultryLink</title>
    <link rel="icon" href="../src/img/logo.svg">
        <script src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
<body>
  <nav class="bg-white shadow-md fixed top-0 left-0 w-full z-20" data-aos="fade-down" data-aos-duration="2000">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <!-- Logo dan Nama PoultryLink -->
      <a href="../index.html" class="flex items-center space-x-2 ml-7">
        <img src="../src/img/logo.svg" alt="PoultryLink Logo" class="h-16 w-16">
        <span class="text-3xl font-bold text-primary">PoultryLink</span>
      </a>
  
      <!-- Link Navigasi (Desktop) -->
      <div class="hidden md:flex space-x-6">
        <a href="../compony/about.html"
          class="text-primary text-xl relative after:absolute after:bg-primary after:h-[2px] after:w-0 after:bottom-0 after:left-0 after:transition-all after:duration-300 hover:after:w-full">Tentang</a>
        <a href="../shop.html"
          class="text-primary text-xl relative after:absolute after:bg-primary after:h-[2px] after:w-0 after:bottom-0 after:left-0 after:transition-all after:duration-300 hover:after:w-full">Produk</a>
      </div>
  
      <!-- Fitur Search, Wishlist, Cart, dan Akun -->
      <div class="md:flex items-center space-x-4 mr-12">
        <!-- Search Bar (Hidden di layar mobile) -->
        <div class="relative w-80 hidden md:block">
          <input type="text" id="searchInput"
            class="border border-primary rounded-full py-2 px-4 w-full text-primary focus:border-primary focus:outline-none"
            placeholder="Search..." />
          <span class="absolute right-3 top-2 text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </span>
        </div>
  
        <!-- Cart Icon -->
        <a href="../cart.html" class="relative text-primary hidden md:block">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 001.99-1.72l1.38-8.28H5.73"></path>
          </svg>
        </a>
  
        <!-- Account Icon with Dropdown -->
        <div class="account-icon relative">
          <a href="#" class="relative text-primary mt-2" id="account-icon" onclick="toggleDropdown(event)">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 00-3-3.87"></path>
              <path d="M4 21v-2a4 4 0 013-3.87"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </a>
          <!-- Dropdown -->
          <div id="account-dropdown"
            class="absolute right-0 mt-2 w-56 bg-white text-primary rounded-lg shadow-lg py-4 opacity-0 invisible transition-opacity duration-300 transform scale-95">

            <!-- Manage Account -->
            <a href="akun/profil.html" id="manage-account-btn"
              class="flex items-center space-x-2 px-4 py-2 mt-2 text-gray-700 hover:bg-primary hover:text-white rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-person-vcard mx-2" viewBox="0 0 16 16">
                <path
                  d="M5 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4m4-2.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5M9 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4A.5.5 0 0 1 9 8m1 2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5">
                </path>
                <path
                  d="M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zM1 4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H8.96q.04-.245.04-.5C9 10.567 7.21 9 5 9c-2.086 0-3.8 1.398-3.984 3.181A1 1 0 0 1 1 12z">
                </path>
              </svg>
              Manage Account
            </a>
            <a href="dashboard/toko.html" id="menu-buka-toko"
              class="flex items-center space-x-2 px-4 py-2 mt-2 text-gray-700 hover:bg-primary hover:text-white rounded-lg">
              <i class="fa-solid fa-shop mx-2"></i>
              Buka toko
            </a>
            <a href="#" id="logout-btn"
              class="flex items-center space-x-2 px-4 py-2 mt-2 text-gray-700 hover:bg-primary hover:text-white rounded-lg transition-colors duration-200">
              <i class="fas fa-sign-out-alt mx-2"></i>
              Logout
            </a>
          </div>
        </div>
      </div>
  

    </div>
  
    <!-- Menu Dropdown (Mobile Only) -->
    <div id="mobile-menu" class="hidden bg-white shadow-md md:hidden">
      <div class="flex flex-col items-start p-4 space-y-4">
        <a href="./compony/about.html" class="text-primary text-xl">Tentang</a>
        <a href="shop.html" class="text-primary text-xl">Produk</a>
        <a href="cart.html" class="text-primary text-xl">Keranjang</a>
        <a href="sign/login.html"
          class="bg-primary text-white hover:text-primary hover:bg-white hover:border border-primary px-4 py-2 rounded-lg">
          Login
        </a>
        <a href="sign/register.html"
          class="bg-white text-primary hover:text-white hover:bg-primary px-4 py-2 rounded-lg border-2 border-primary">
          Register
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="max-w-7xl mx-auto p-6 mt-20">
    <!-- Account Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Sidebar -->
      <aside class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl shadow-lg">
        <!-- Profil Pengguna -->
        <div class="flex items-center space-x-4 mb-8">
          <div class="relative">
            <img id="profile_image" class="h-20 w-20 rounded-full object-cover shadow-md border-4 border-white" src="https://via.placeholder.com/64" alt="User profile picture">
            <span class="absolute bottom-0 right-0 h-4 w-4 bg-green-400 border-2 border-white rounded-full"></span> <!-- Status online -->
          </div>
          <div>
            <p id="profile_username" class="text-xl font-bold text-gray-900"></p>
            <p id="profile_greeting" class="text-gray-500"></p>
          </div>
        </div>
        
        <!-- Navigasi Sidebar -->
        <nav class="space-y-4">
          <a href="profil.html" class="flex items-center px-4 py-3 rounded-lg bg-gray-100 text-gray-800 hover:bg-blue-100 hover:shadow-md transition-all duration-200">
            <i class="fas fa-user mr-3 text-primary"></i> <span class="font-medium">Informasi Profil</span>
          </a>
          
          <hr class="border-gray-200 my-4">
      
          <a href="history.html" 
            class="group flex items-center px-4 py-3 rounded-lg bg-primary text-white hover:bg-white hover:text-primary hover:shadow-md transition-all duration-700 hover:border hover:border-primary">
            <i class="fas fa-history mr-3 text-white group-hover:text-primary transition-all duration-700"></i> 
            <span class="font-medium">Riwayat pembelian</span>
          </a>
        </nav>
      </aside>

      <!-- History Transaksi -->
      <div class="md:col-span-2 bg-white p-2 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Riwayat Transaksi</h2>
        <div class="overflow-x-auto bg-gray-50 rounded-lg shadow-md">
          <table class="min-w-full bg-white border border-gray-300 rounded-lg" id="data-order">
            <thead>
              <tr class="bg-primary text-white">
                <th class="py-3 px-4">Tanggal</th>
                <th class="py-3 px-4">Jumlah</th>
                <th class="py-3 px-4">Total Harga</th>
                <th class="py-3 px-4">Invoice</th>
                <th class="py-3 px-4">Status</th>
                <th class="py-3 px-4">konfirmasi</th>
              </tr>
            </thead>
            <tbody>

              <!-- Tambahkan lebih banyak transaksi sesuai kebutuhan -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
   <script>
      $(document).ready(function () {
        const token = localStorage.getItem('auth_token');

        $.ajax({
            url: 'http://127.0.0.1:8000/api/getprofile', // Pastikan ini URL API yang benar
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function (response) {
                console.log(response); // Debugging respons
    
                if (response.data) {
                    $('#profile_username').text(response.data.user.username);
                    $('#profile_greeting').text('Hello, ' + response.data.user.username);
                    
                    // Ambil avatar_path dari respons dan tampilkan di gambar profil
                    const profileImageUrl = response.data.avatar_path;
                    if (profileImageUrl) {
                        // Periksa apakah URL lengkap atau perlu di-append dengan base URL
                        const fullImageUrl = profileImageUrl.startsWith('http') 
                            ? profileImageUrl 
                            : `https://hbssyluucrwsbfzspyfp.supabase.co/storage/v1/object/avatar/${profileImageUrl}/1.jpg`;
    
                        // Periksa jika URL gambar valid, jika tidak gunakan placeholder
                        const img = new Image();
                        img.onload = function () {
                            // Jika gambar berhasil dimuat, tampilkan gambar
                            $('#profile_image').attr('src', fullImageUrl);
                        };
                        img.onerror = function () {
                            // Jika gambar gagal dimuat, gunakan placeholder
                            $('#profile_image').attr('src', 'https://via.placeholder.com/64');
                        };
                        img.src = fullImageUrl;
                    } else {
                        // Jika tidak ada avatar, gunakan placeholder
                        $('#profile_image').attr('src', 'https://via.placeholder.com/64');
                    }
                }
            },
            error: function (xhr) {
                console.log("Error:", xhr.responseText);
            }
        });
      });
    </script>
    
    <script>
    $(document).ready(function () {
        const token = localStorage.getItem('auth_token');
        // Ambil data order dengan AJAX
        $.ajax({
            url: 'http://127.0.0.1:8000/api/buyerorder', // Endpoint untuk mengambil data order
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function (response) {
                const tbody = $('#data-order tbody');
                tbody.empty(); // Kosongkan tbody sebelum mengisi
    
                response.data.forEach((order) => {
                    // Format data sesuai kebutuhan
                    const tanggal = new Date(order.created_at).toLocaleDateString(); // Format Tanggal
                    const jumlah = order.total; // Jumlah
                    const totalHarga = `Rp ${parseInt(order.harga).toLocaleString('id-ID')}`; // Total Harga
                    const invoiceLink = order.invoice
                        ? `<a href="../invoice.html?id=${order.id}" class="text-primary underline">Lihat Invoice</a>`
                        : 'Tidak Ada'; // Link Invoice
                    
                    // Periksa status order
                    let status;
                    let konfirmasiButton;
                    if (order.confirmed === 'yes') {
                        status = 'Terkonfirmasi';
                        konfirmasiButton = `
                            <a href="#" class="text-xl text-primary ml-7 fa-solid fa-square-check"
                                style="margin-left: 3rem;" 
                                onclick="confirmOrder(${order.id}); return false;">
                            </a>`;
                    } else if (order.confirmed === 'cancelled') {
                        status = 'Dibatalkan';
                        konfirmasiButton = `<span class="text-gray-400 ml-7 fa-solid fa-ban" style="margin-left: 3rem;" title="Tidak dapat dikonfirmasi"></span>`;
                    } else if (order.confirmed === 'retrieved') {
                        status = 'Diterima';
                        konfirmasiButton = `<span class="text-gray-400 ml-7 fa-solid fa-square-check" style="margin-left: 3rem;" title="Sudah Diterima"></span>`;
                    } else {
                        status = 'Belum Dikonfirmasi';
                        konfirmasiButton = `<span class="text-gray-400 ml-7 fa-solid fa-ban" style="margin-left: 3rem;" title="Tidak dapat dikonfirmasi"></span>`;
                    }
    
                    // Tambahkan baris ke tabel
                    const row = `
                        <tr class="hover:bg-gray-100 transition-colors">
                            <td class="py-3 px-4 border-b">${tanggal}</td>
                            <td class="py-3 px-4 border-b ml-4">${jumlah}</td>
                            <td class="py-3 px-4 border-b">${totalHarga}</td>
                            <td class="py-3 px-4 border-b">${invoiceLink}</td>
                            <td class="py-3 px-4 border-b">${status}</td>
                            <td class="py-3 px-4 border-b">${konfirmasiButton}</td>
                        </tr>
                    `;
    
                    tbody.append(row); // Masukkan baris ke dalam tbody
                });
            },
            error: function (xhr) {
                alert('Gagal memuat data order: ' + xhr.responseText);
            },
        });
    });
    
    // Fungsi untuk konfirmasi order
    function confirmOrder(orderId) {
        const token = localStorage.getItem('auth_token');
        Swal.fire({
            title: 'Konfirmasi Order',
            text: 'Apakah Anda yakin ingin mengonfirmasi order ini?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Konfirmasi!',
            cancelButtonText: 'Batal',
        }).then((result) => {
            if (result.isConfirmed) {
                // Jika pengguna mengonfirmasi
                $.ajax({
                    url: `http://127.0.0.1:8000/api/terimaorder/${orderId}`, // Endpoint untuk konfirmasi order
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (response) {
                        Swal.fire({
                            title: 'Berhasil!',
                            text: 'Order berhasil dikonfirmasi.',
                            icon: 'success',
                            confirmButtonText: 'OK',
                        }).then(() => {
                            location.reload(); // Refresh halaman setelah sukses
                        });
                    },
                    error: function (xhr) {
                        Swal.fire({
                            title: 'Gagal!',
                            text: 'Terjadi kesalahan saat mengonfirmasi order.',
                            icon: 'error',
                            confirmButtonText: 'OK',
                        });
                    },
                });
            }
        });
    }
    </script>
    
    <!--mengecek apakah suplier atau bukan-->
  <script>
    $(document).ready(function () {
      const base_url = window.location.origin; // Mendapatkan base URL
      const token = localStorage.getItem('auth_token'); // Mendapatkan token dari localStorage

      // Fungsi untuk mengecek apakah user terdaftar sebagai supplier
      function checkSupplierStatus() {
        if (token) {
          $.ajax({
            url: 'http://127.0.0.1:8000/api/checkSupplier',// URL endpoint untuk mengecek status supplier
            type: 'GET',
            headers: {
              'Authorization': `Bearer ${token}` // Kirim token untuk autentikasi
            },
            success: function (response) {
              // Jika terdaftar sebagai supplier, simpan id_supplier ke localStorage
              if (response.id_supplier) {
                localStorage.setItem('id_supplier', response.id_supplier);
                $('#menu-buka-toko').hide(); // Sembunyikan tombol "Buka Toko"
              } else {
                localStorage.removeItem('id_supplier');
                $('#menu-buka-toko').show(); // Tampilkan tombol "Buka Toko"
              }
            },
            error: function (xhr, status, error) {
              console.error('Error checking supplier status:', error);
            }
          });
        } else {
          // Jika token tidak ditemukan, berarti user belum login
          console.log('User not logged in');
        }
      }

      // Panggil fungsi untuk cek status supplier saat halaman dimuat
      checkSupplierStatus();
    });
  </script>



  <script src="../src/js/script.js"></script>
</body>
</html>